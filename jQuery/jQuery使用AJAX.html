<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>jQuery使用AJAX使用</title>
        <link rel="stylesheet" href="./jQuery-common.css">
        <style>
            .srk {
                width: 300px;
                height: 30px;
                padding-left: 5px;
                font-size: 14px;
                margin-top: 10px;
                display: none;
            }

            .phone_loc {
                width: 100px;
                padding-left: 10px;
                margin-top: 10px;
                display: none;
            }

            /* 正在请求提示 */
            .loading-box {
                width: 300px;
                height: 300px;
                line-height: 300px;
                color: #ccc;
                font-size: 15px;
                text-align: center;
                display: none;
            }

            /* 天气预报省市区选择 */
            .weather-select {
                margin-top: 10px;
            }

            /* 天气预报结果显示区 */
            .weather-result {

            }
        </style>
    </head>
    <body>
        <div class="right">
            <div class="container-box">
                <select name="" id="req_list">
                    <optgroup label="互联网功能选择(跨域请求)">
                            <option value="weather">天气预报</option>
                            <option value="phone">手机号码归属地查询</option>
                            <option value="identity">身份证查询</option>
                            <option value="ip">IP查询</option>
                            <option value="jokes">笑话大全</option>
                            <option value="wechat">微信精选</option>
                            <option value="news">新闻头条</option>
                            <option value="history">历史上的今天</option>
                    </optgroup> 
                    <optgroup label="本地功能选择(非跨域请求)">
                        <option value="loca_news">新闻资讯</option>
                    </optgroup>   
                </select>

                <select name="" id="req_method">
                    <optgroup label="请求方式">
                        <option value="GET">GET</option>
                        <option value="POST" id="opt_post">POST</option>
                    </optgroup>
                </select>

                <select name="" id="req_type">
                    <optgroup label="请求类型">
                        <option value="asyn">异步</option>
                        <option value="syn" disabled=true>同步</option>
                    </optgroup>
                </select>
                <br>

                <!-- 天气预报参数选择区 -->
                <div class="weather-select" id="weather_select">
                    <select name="" id="province">
                        <option value="">省</option>
                    </select>
                    <select name="" id="city">
                        <option value="">市</option>
                    </select>
                    <select name="" id="district">
                        <option value="">区</option>
                    </select>
                </div>

                <!-- 输入框 查询手机归属地 查询身份证 查询ip等功能的参数选择区 -->
                <input
                    class="srk"
                    id="srk"
                    type="text">

                <!-- 正在请求提示 loading -->
                <div class="loading-box" id="loading_box">
                    请求服务器中...
                </div>

                <!-- 天气预报结果显示区 -->
                <div class="weather-result" id="weather_result">

                </div>

                <!-- 手机号归属地查询结果区 -->
                <div class="phone_loc" id="phone-loc">
                    <p>
                        <span>省:
                        </span>
                        <span id="province"></span>
                    </p>
                    <p>
                        <span>市:
                        </span>
                        <span id="city"></span></p>
                    <p>
                        <span>区号:
                        </span>
                        <span id="loc_number"></span></p>
                    <p>
                        <span>邮编:
                        </span>
                        <span id="postcode"></span></p>
                    <p>
                        <span>运营商:
                        </span>
                        <span id="company"></span></p>
                </div>
            </div>
        </div>

        <h4>1. AJAX请求数据</h4>
        <div class="box">
            <span class="full-syntax">$.ajax(url,[settings])</span>
            <div class="box">
                <div>
                    GET请求数据方式一:
                    <button id="btn_ajax_get1">发送请求</button>
                    <span class="current-syntax">$.ajax({url:urlValue, type:"get", dataType:"jsonp",
                        successFn:fn, errorFn:fn, complete: completeFn})</span>
                </div>

                <div>
                    GET请求数据方式二:
                    <button id="btn_ajax_get2">GET查询手机号码归属地</button>
                    <span class="current-syntax">$.ajax({url:urlValue, data:paramString, type:"get",
                        dataType:"jsonp", successFn:fn, errorFn:fn})</span>
                </div>

                <div>
                    GET请求数据方式三:
                    <button id="btn_ajax_get3">GET查询手机号码归属地</button>
                    <span class="current-syntax">$.ajax({url:urlValue, data:paramObj, type:"get",
                        dataType:"jsonp", successFn:fn, errorFn:fn})</span>
                </div>
            </div>

        </div>
    </body>
</html>
<script src="./jquery-3.4.1.min.js"></script>
<script>
    $(function () {

        // 不同功能对应的参数信息
        var request_info = {
            // 天气预报
            "weather": {
                url: "http://apis.juhe.cn/simpleWeather/query",
                appkey: "d19e809c098780def41f3be0921aaef2",
                params: ["city"],
                onlyGet: false
            },
            // 手机号码归属地查询
            "phone": {
                url: "http://apis.juhe.cn/mobile/get",
                appkey: "f3c0e48da13bf0793f67e021f062703b",
                params: ["phone", "dtype"],
                onlyGet: true
            },
            // 身份证查询
            "identity": {
                url: "http://apis.juhe.cn/idcard/index",
                appkey: "4c42edd122b2a4eb3bfc190bfd36c010",
                params: ["cardno", "dtype"],
                onlyGet: true
            },
            // IP查询
            "ip": {
                url: "http://apis.juhe.cn/ip/ipNew",
                appkey: "74c1c1c7882f034f028f59d2462efdad",
                params: ["ip"],
                onlyGet: false
            },
            // 笑话大全
            "jokes": {
                url: "http://v.juhe.cn/joke/content/list.php",
                appkey: "612f292e6a4a3d022c56abf1f92fa13a",
                params: ["sort", "page", "pagesize", "time"],
                onlyGet: true
            },
            // 微信精选
            "wechat": {
                url: "http://v.juhe.cn/weixin/query",
                appkey: "b2ae6c8199202c22841bbb1a76098b68",
                params: ["pno", "ps", "dtype"],
                onlyGet: false
            },
            // 新闻头条
            "news": {
                url: "http://v.juhe.cn/toutiao/index",
                appkey: "b0ed05cedb5c70148be25e392a09ccbb",
                params: ["type"],
                onlyGet: false
            },
            // 历史上的今天
            "history": {
                url: "http://api.juheapi.com/japi/toh",
                appkey: "2d6479fcfd18aa080a0ea69534343597",
                params: ["v", "month", "day"],
                onlyGet: false
            },
            // 空
            "default": {
                url: "",
                appkey: "",
                params: [],
                onlyGet: false
            }
        }

        // 不同功能对应的参数选项区和请求结果显示区
        var params_result_area = {
            // 天气
            weather: {
                // 参数选择区
                params_area: [$("#srk")],
                // 结果显示区
                result_area: []
            },

        }

        // 输入框
        var $srk = $("#srk");
        // 请求方式
        var req_method = "GET";
        // 请求类型 是否是异步请求
        var isAsyn = true;
        // 正在请求提示
        var $loading_box = $("#loading_box");
        
        // 手机号码归属地查询结果显示区
        var $phone_result = $("#phone-loc");

        // 当前请求对应的request_info里面对象
        var current_info_obj = null;
        // url
        var req_url = "";
        // appkey
        var appKey = "";
        // 参数列表
        var params = [];
        // 是否只能用GET请求
        var onlyGet = false;

        // 切换功能
        $("#req_list").change(function () {
            switch ($(this).val()) {
                case "weather":
                    // 天气预报
                    $srk.show();
                    $srk.attr("placeholder","请输入城市名");

                    // 当前请求对应的request_info里面对象
                    var current_info_obj = request_info.weather;
                    break;
                case "phone":
                    // 手机号码归属地查询
                    $srk.show();
                    $srk.attr("placeholder","请输入手机号码");
                    $srk.val("13761943167");

                    // 当前请求对应的request_info里面对象
                    var current_info_obj = request_info.phone;
                    break;
                case "identity":
                    // 身份证查询
                    $srk.show();
                    $srk.attr("placeholder","请输入身份证号");
                    break;
                case "ip":
                    // ip查询
                    $srk.show();
                    $srk.attr("placeholder","请输入ip地址");
                    break;
                default:
                    // 当前请求对应的request_info里面对象
                    var current_info_obj = request_info.default;
                    break;
            }

            // url
            req_url = current_info_obj.url;
            // appkey
            appKey = current_info_obj.appkey;
            // 参数列表
            params = current_info_obj.params;
            // 是否只能用GET请求
            onlyGet = current_info_obj.onlyGet;
            if(onlyGet){
                $("#req_method").val("GET");
                $("#opt_post").attr("disabled",true);
            }else {
                $("#opt_post").attr("disabled",false);
            }

            // 跨域的请求只支持异步
            if($("option:selected",this).parent().index() == 0){
                // 选中互联网功能 只能选择异步
                $("option[value=syn]").attr("disabled",true);
                $("#req_type").val("asyn");
                isAsyn = true;
            }else {
                // 选中本地功能 可以切换同步 异步
                $("option[value=syn]").attr("disabled",false);
            }
        })

        // 请求方式切换
        $("#req_method").change(function(){
            req_method = $(this).val();
        })

        // 请求类型切换
        $("#req_type").change(function(){
            isAsyn = $(this).val() == "asyn" ? true : false;
        })

        // 参数处理
        function paramsHandle(){
            // 遍历参数列表
            var params_handled = {};
            for (var i = 0; i < params.length; i++){
                switch(params[i]){
                    case "phone":
                        params_handled.phone = $srk.val();
                        break;
                    case "city":
                        params_handled.city = getWeatherCityId();
                        break;
                    case "cardno":
                        params_handled.cardno = $srk.val();
                        break;
                    case "ip":
                        params_handled.ip = $srk.val();
                        break;
                    case "dtype":
                        params_handled.dtype = "json";
                        break;
                }
            }

            // 设置key参数
            params_handled.key = appKey;

            return params_handled;
        }

        // url拼接
        function urlHandle(originUrl, params_obj){
            // 拼接url
            var current_url = originUrl + "?";
            for (var key in params_obj) {
                current_url += (key + "=" + params_obj[key] + "&");
            }

            return current_url;
        }

        // 请求发送前
        function beforSend(jqXHR){
            console.log("准备开始发送请求:" + JSON.stringify(jqXHR));

            // 正在请求显示
            $loading_box.show();

            // 隐藏所有结果显示区
            $phone_result.hide();
        }

        // 请求完成回调函数
        function requestComplete(jqXHR, textStatus){
            // 正在请求隐藏
            $loading_box.hide();

             // 输入框可以输入
             openInputBox();

            // 请求完成 失败和成功都会调用
            console.log("请求完成");
            console.log("请求对象信息:" + JSON.stringify(jqXHR));
            console.log("请求结果状态:" + textStatus);
        }

        // 请求失败回调
        function requestError(jqXHR, textStatus, errorThrown){
            alert("请求出错:" + errorThrown);

            // 请求出错
            console.log("请求失败");
            console.log("请求对象信息:" + JSON.stringify(jqXHR));
            console.log("请求结果状态:" + textStatus);
        }

        // 请求成功回调
        function requestSuccess(data, textStatus, jqXHR) {
            // 正在请求隐藏
            $loading_box.hide();

            // 解析请求结果
            resolvePhoneNumberInfo(data);

            // 请求结果附加信息
            console.log("请求成功");
            console.log("请求结果状态:" + textStatus);
            console.log("请求对象信息:" + JSON.stringify(jqXHR));
        }


        // GET请求手机归属地方式一
        $("#btn_ajax_get1").click(function () {
            // 处理以后的参数 转换为键值对
            var current_params = paramsHandle();
            // 输入框内容
            var srk_value = $srk.val();

            // 拼接url
            var current_url = urlHandle(req_url,current_params);

            $.ajax({
                url: "http://v.juhe.cn/joke/content/list.php?key=612f292e6a4a3d022c56abf1f92fa13a&sort=desc&time=1418816972",
                type: "get",
                dataType: "jsonp",
                success: function(data){
                    console.log("请求成功");
                },
                error: function(){
                    console.log("请求失败");
                }
            })
            
            // $.ajax({
            //     url: current_url,
            //     type: "get",
            //     async: false,
            //     dataType: "jsonp",
            //     beforeSend:beforSend,
            //     success: requestSuccess,
            //     error: requestError,
            //     complete: function(jqXHR, textStatus){
            //         // 显示结果区
            //         $phone_result.show();

            //         requestComplete(jqXHR, textStatus);
            //     },
            // })
        })

        // GET请求手机归属地方式二
        $("#btn_ajax_get2").click(function () {
            // 请求过程中禁止输入
            closeInputBox();

            // 手机号码
            var phone_number = $("#phone_number").val();

            // data: {phone: phone_number, dtype: "json", key: phone_number_key},
            $.ajax({
                url: "http://apis.juhe.cn/mobile/get",
                data: "phone=" + phone_number + "&dtype=json&key=" + phone_number_key,
                type: "get",
                dataType: "jsonp",
                success: function (data, textStatus, jqXHR) {
                    // 解析请求结果
                    resolvePhoneNumberInfo(data);

                    // 请求结果附加信息
                    console.log("请求成功");
                    console.log("请求结果状态:" + textStatus);
                    console.log("请求对象信息:" + JSON.stringify(jqXHR));
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert("请求出错:" + errorThrown);

                    // 请求出错
                    console.log("请求失败");
                    console.log("请求对象信息:" + JSON.stringify(jqXHR));
                    console.log("请求结果状态:" + textStatus);
                },
                complete: requestComplete(jqXHR,textStatus),
            })
        })

        // GET请求手机归属地方式三
        $("#btn_ajax_get3").click(function () {
            // 手机号码
            var phone_number = $("#phone_number").val();

            // 参数
            var params = "phone=" + phone_number + "&key=" + phone_number_key;

            // 使用ajax
            $.ajax();
            // 设置url

        })

        // 请求过程中禁止输入框输入内容
        function closeInputBox() {
            $srk.attr("disabled", true);
            $srk.css("color", "#ccc");
        }

        // 请求完成后输入框可以输入内容
        function openInputBox() {
            $srk.attr("disabled", false);
            $srk.css("color", "#000");
        }

        // 解析手机归属地信息
        function resolvePhoneNumberInfo(result) {
            // 请求结果错误码
            var errorCode = result.error_code;

            // 查询结果信息
            var resultInfo = result.result;

            // 错误信息描述
            var errorMessage = result.reason;

            // 请求失败
            if (errorCode != 0) {
                alert("手机号归属地查询失败:\n" + errorMessage);
                return;
            }

            // 请求成功 界面赋值 省
            $("#province").text(resultInfo.province);
            // 市
            $("#city").text(resultInfo.city);
            // 区号
            $("#loc_number").text(resultInfo.areacode);
            // 邮编
            $("#postcode").text(resultInfo.zip);
            // 运营商
            $("#company").text(resultInfo.company);
        }

        // 请求天气预报支持的省市区
        var cities_info = [];
        // 省 市 区联动数据
        var province_cities_districts = {};
        // 当前选择的省
        var current_select_province = "";
        // 当前选择的市
        var current_select_city = "";
        // 当前选择的区
        var current_select_district = "";

        // 加载并处理天气预报支持的城市数据
        // 由于省市区接口不能跨域访问 所以只能保存到本地获取
        loadWeatherCities();
        function loadWeatherCities(){
            $.ajax({
                url: "jQuery_weather_cities.json",
                async: true,
                success: function(data){
                    // 保存请求回来的元数据
                    cities_info = data.result;

                    // 处理数据
                    weatherCitiesHandle();
                }
            })
        }

        // 处理天气预报城市数据
        function weatherCitiesHandle(){
            // 遍历城市数据 转换成省市区联动数据
            var provinces_temp = [];
            var cities_temp = {};
            var districts_temp = {};
            for(var i = 0; i < cities_info.length; i++){
                var current_province = cities_info[i].province;
                var current_city = cities_info[i].city;
                var current_district = cities_info[i].district;


                // 省
                var myProvince = province_cities_districts[current_province];
                if(myProvince == undefined){
                    myProvince = {};
                    province_cities_districts[current_province] = myProvince;
                }

                // 市
                var myCity = myProvince[current_city];
                if(myCity == undefined){
                    myCity = [];
                    province_cities_districts[current_province][current_city] = myCity;
                }

                // 区
                var myDistrict = myCity.indexOf(current_district);
                if(myDistrict == -1){
                    province_cities_districts[current_province][current_city].push(current_district);
                }
            }

            // 省显示到界面上
            for (var key in province_cities_districts) {
                // 添加省
                var province_node = $("<option value=" + key + ">" + key + "</option>")
                $("#province").append(province_node);
            }
        }

        // 省选择发生变化 市和区联动
        $("#province").change(function(){
            // 记录当前选择的省
            current_select_province = $(this).val();

            // 移除老的市数据
            $("#city").children().remove("option[value!='']");
            current_select_city = "";

            // 添加新的市数据
            for (var key in province_cities_districts[current_select_province]) {
                var city_node = $("<option value=" + key + ">" + key + "</option>")
                $("#city").append(city_node);
            }

            // 移除老的区数据
            $("#district").children().remove("option[value!='']");
            current_select_district = "";
        })

        // 市选择繁盛变化 区联动
        $("#city").change(function(){
            // 记录选中的市
            current_select_city = $(this).val();

            // 移除老的区数据
            $("#district").children().remove("option[value!='']");
            current_select_district = "";

            // 添加新的区数据
            var current_districts = province_cities_districts[current_select_province][current_select_city];
            for(var i = 0; i < current_districts.length; i++){
                var district_node = $("<option value=" + current_districts[i] + ">" + current_districts[i] + "</option>")
                $("#district").append(district_node);
            }
        })

        // 区选择发生改变 记录选中的区 
        $("#district").change(function(){
            current_select_district = $(this).val();
        })

        // 获取选中省市区对应的id
        function getWeatherCityId(){
            // 当前选中的省市区对应的id
            var current_select_result_id = "";

            for(var i = 0; i < cities_info.length; i ++){
                var current_obj = cities_info[i];
                if(current_select_province.length > 0 && current_select_province == current_obj.province){
                    if(current_select_city.length > 0 && current_select_city == current_obj.city){
                        if(current_select_district.length > 0 && current_select_district == current_obj.district){
                            current_select_result_id = current_obj.id;
                            break;
                        }
                    }
                }
            }

            return current_select_result_id;
        }
    })
</script>